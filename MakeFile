# -----------------------------
# Config
# -----------------------------
DSTEST_ROOT := $(abspath .)
APTOS_DIR   := $(DSTEST_ROOT)/aptos

APTOS_CORE ?= $(abspath $(DSTEST_ROOT)/../aptos-core)

DSTEST_BIN  := $(DSTEST_ROOT)/cmd/dstest/main
APTOS_NODE  := $(APTOS_CORE)/target/release/aptos-node
APTOS_CLI   := $(APTOS_CORE)/target/cli/aptos

# venv
VENV_DIR := $(DSTEST_ROOT)/.venv
VENV_PY  := $(VENV_DIR)/bin/python3
PIP      := $(VENV_DIR)/bin/pip

# base directory for the generated genesis + node configs
BASE_DIR ?= /tmp/aptos-dstest

# dsTest config path
CONFIG ?= $(DSTEST_ROOT)/aptos/configs/aptos.yml

# localnet config
NUM_REPLICAS ?= 4
CHAIN_ID ?= 42
EPOCH_DURATION_SECS ?= 7200

# Genesis artifacts
GENESIS_DIR  := $(BASE_DIR)/genesis
FRAMEWORK_MRB := $(GENESIS_DIR)/framework.mrb

# node config ports
BASE_PORT ?= 8000

# logs output directory
RUN_ID ?= $(shell date +"%Y%m%d_%H%M%S")
OUTPUT_BASE ?= output/aptos
OUTPUT_DIR ?= $(OUTPUT_BASE)/$(RUN_ID)

# for filtering the logs output
FILTER_OUT ?= $(OUTPUT_DIR)/consensus_filtered.jsonl
FILTER_TEXT ?= $(OUTPUT_DIR)/consensus_filtered.log

# for generating a config
# TEST_NAME is an experiment's name, can be anything
# SCHED_TYPE can be random, pct, ql
TEST_NAME ?= aptos-localnet
SCHED_TYPE ?= pct

# logging pass-through (empty by default)
RUST_LOG ?= warn,aptos_consensus=debug,aptos_network=info
LOG_LEVEL ?=

# -----------------------------
# Helpers
# -----------------------------
.PHONY: help
help:
	@echo "Targets:"
	@echo "  make setup                 # create venv + install python deps"
	@echo "  make build                 # build aptos-node + aptos-cli + dstest"
	@echo "  make framework    			# build framework.mrb (cached)"
	@echo "  make genesis               # generate genesis.blob + waypoint.txt"
	@echo "  make node-configs          # generate node.yaml + per-node dirs"
	@echo "  make seeds                 # (optional) patch seed_addrs (not used yet)"
	@echo "  make config                # generate config file aptos.yml for dsTest"
	@echo "  make clean                 # kill nodes + wipe state"
	@echo "  make run                   # run dsTest with CONFIG"
	@echo "  make all                   # build + genesis + node-configs + seeds + config + run"
	@echo "  make filter-logs           # filter the consensus log output
	@echo "  make run-and-filter        # run dsTest with CONFIG and filter the logs
	@echo ""
	@echo "Vars:"
	@echo "  APTOS_CORE=$(APTOS_CORE)"
	@echo "  BASE_DIR=$(BASE_DIR)"
	@echo "  NUM_REPLICAS=$(NUM_REPLICAS)"
	@echo "  BASE_PORT=$(BASE_PORT)"
	@echo "  CONFIG=$(CONFIG)"
	@echo "  RUST_LOG=$(RUST_LOG)"
	@echo "  LOG_LEVEL=$(LOG_LEVEL)"

# -----------------------------
# Python venv + deps
# -----------------------------
$(VENV_PY):
	python3 -m venv $(VENV_DIR)

.PHONY: setup
setup: $(VENV_PY)
	$(PIP) install --upgrade pip
	$(PIP) install pyyaml cryptography

# -----------------------------
# Builds
# -----------------------------
.PHONY: build-aptos
build-aptos:
	cd $(APTOS_CORE) && cargo build --release -p aptos-node
	cd $(APTOS_CORE) && cargo build -p aptos --profile cli

.PHONY: build-dstest
build-dstest:
	cd $(DSTEST_ROOT)/cmd/dstest && go build -o main .

.PHONY: build
build: build-aptos build-dstest
	@test -x $(APTOS_NODE) || (echo "Missing $(APTOS_NODE) (build-aptos failed?)"; exit 1)
	@test -x $(APTOS_CLI)  || (echo "Missing $(APTOS_CLI)  (build-aptos failed?)"; exit 1)
	@test -x $(DSTEST_BIN) || (echo "Missing $(DSTEST_BIN) (build-dstest failed?)"; exit 1)

# -----------------------------
# Aptos Framework MRB
# -----------------------------

$(FRAMEWORK_MRB):
	@mkdir -p "$(GENESIS_DIR)"
	@if [ -f "$(FRAMEWORK_MRB)" ]; then \
	  echo "[framework] Reusing existing $(FRAMEWORK_MRB)"; \
	else \
	  echo "[framework] Building framework MRB..."; \
	  cd "$(APTOS_CORE)" && cargo run -p aptos-framework -- release --target head >/dev/null; \
	  test -f "$(APTOS_CORE)/head.mrb" || (echo "ERROR: head.mrb missing"; exit 1); \
	  cp -f "$(APTOS_CORE)/head.mrb" "$(FRAMEWORK_MRB)"; \
	  echo "[framework] Wrote $(FRAMEWORK_MRB)"; \
	fi

.PHONY: framework
framework: $(FRAMEWORK_MRB)

# -----------------------------
# Genesis + node configs
# -----------------------------
.PHONY: genesis
genesis: framework setup build
	@mkdir -p $(BASE_DIR)
	BASE_DIR="$(BASE_DIR)" \
	GENESIS_DIR="$(GENESIS_DIR)" \
	FRAMEWORK_MRB="$(FRAMEWORK_MRB)" \
	NUM_NODES="$(NUM_REPLICAS)" \
	CHAIN_ID="$(CHAIN_ID)" \
	EPOCH_DURATION_SECS="$(EPOCH_DURATION_SECS)" \
	APTOS_CORE="$(APTOS_CORE)" \
	APTOS_CLI="$(APTOS_CLI)" \
	PYTHON_BIN="$(VENV_PY)" \
	bash $(APTOS_DIR)/aptos_prepare_localnet.sh

.PHONY: node-configs
node-configs: genesis
	BASE_DIR=$(BASE_DIR) \
	GENESIS_DIR="$(GENESIS_DIR)" \
	APTOS_CORE="$(APTOS_CORE)" \
	NUM_NODES="$(NUM_REPLICAS)" \
	BASE_PORT="${BASE_PORT}" \
	PYTHON_BIN="$(VENV_PY)" \
	bash $(APTOS_DIR)/aptos_make_node_configs.sh

# Seed patch
.PHONY: seeds
seeds: node-configs
	BASE_DIR="$(BASE_DIR)" CONFIG="$(CONFIG)" \
	"$(VENV_PY)" "$(APTOS_DIR)/aptos_update_seeds.py"

# -----------------------------
# dsTest config generation
# -----------------------------
.PHONY: config
config:
	@mkdir -p "$(OUTPUT_DIR)"
	@mkdir -p $(APTOS_DIR)/configs
	@echo "Writing $(CONFIG)"
	@{ \
	echo "TestConfig:"; \
	echo "  Name: $(TEST_NAME)"; \
	echo "  Experiments: 1"; \
	echo "  Iterations: 2"; \
	echo "  WaitDuration: 100"; \
	echo "  StartupDuration: 1"; \
	echo ""; \
	echo "SchedulerConfig:"; \
	echo "  Type: \"$(SCHED_TYPE)\""; \
	echo "  Steps: 50"; \
	echo "  Seed: 42"; \
	echo "  Params: {\"client_request_probability\": 0.01, \"d\": 2}"; \
	echo ""; \
	echo "NetworkConfig:"; \
	echo "  BaseReplicaPort: $(BASE_PORT)"; \
	echo "  BaseInterceptorPort: 10000"; \
	echo "  Protocol: \"tcp\""; \
	echo "  MessageType: TCP"; \
	echo ""; \
	echo "FaultConfig:"; \
	echo "  Faults: []"; \
	echo ""; \
	echo "ProcessConfig:"; \
	echo "  NumReplicas: $(NUM_REPLICAS)"; \
	echo "  Timeout: 100"; \
	echo "  OutputDir:  $(OUTPUT_DIR)"; \
	echo "  ReplicaScript: aptos/aptos_server.sh"; \
	echo "  ClientScripts: []"; \
	echo "  CleanScript: aptos/aptos_clean.sh"; \
	echo "  ReplicaParams:"; \
	for i in $$(seq 0 $$(( $(NUM_REPLICAS) - 1 ))); do \
	  echo "    - \"$$i $(BASE_DIR)\""; \
	done; \
	} > $(CONFIG)

# -----------------------------
# Clean + run
# -----------------------------
.PHONY: clean clean-outputs

clean:
	@chmod +x $(APTOS_DIR)/aptos_clean.sh $(APTOS_DIR)/aptos_server.sh || true
	BASE_DIR=$(BASE_DIR) bash $(APTOS_DIR)/aptos_clean.sh $(BASE_DIR) || true
	@# DO NOT delete dsTest outputs here (keep all runs)

# Only run this when you explicitly want to wipe all previous runs
clean-outputs:
	rm -rf $(DSTEST_ROOT)/output || true

.PHONY: run
run: build
	@chmod +x $(APTOS_DIR)/aptos_server.sh $(APTOS_DIR)/aptos_clean.sh || true
	@echo "Running dsTest with:"
	@echo "  CONFIG=$(CONFIG)"
	@echo "  BASE_DIR=$(BASE_DIR)"
	@echo "  RUST_LOG=$(RUST_LOG)"
	@echo "  LOG_LEVEL=$(LOG_LEVEL)"
	cd $(DSTEST_ROOT)/cmd/dstest && \
	  RUST_LOG="$(RUST_LOG)" LOG_LEVEL="$(LOG_LEVEL)" BASE_DIR="$(BASE_DIR)" \
	  ./main run -c "$(CONFIG)"

.PHONY: all
all: clean node-configs seeds config run

.PHONY: filter-logs
filter-logs:
	TEST_NAME="$(TEST_NAME)" SCHED_TYPE="$(SCHED_TYPE)" \
	"$(VENV_PY)" "$(APTOS_DIR)/filter_consensus_logs.py" "$(OUTPUT_DIR)" --levels INFO,DEBUG

.PHONY: run-and-filter
run-and-filter:
	@set -e; \
	RUN_ID=$$(date +"%Y%m%d_%H%M%S"); \
	echo "[run-and-filter] RUN_ID=$$RUN_ID"; \
	$(MAKE) RUN_ID=$$RUN_ID clean; \
	$(MAKE) RUN_ID=$$RUN_ID config; \
	$(MAKE) RUN_ID=$$RUN_ID run; \
	$(MAKE) RUN_ID=$$RUN_ID filter-logs